<!DOCTYPE html>
<html>

<head>
	<title>Artememoria Map</title>
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div class="mapa-zona-centro">
		<div id="map-viewport">
			<div id="map-container">
				<img id="map" src="img/map.jpg">
			</div>
			<div id="point-info">
				<p id="point-info-text"></p>
				<div id="point-return">&larr; Return to Map</div>
			</div>
		</div>
		<img id="key" src="img/key.jpg">
		<button id="map-zoom-in">+</button>
		<button id="map-zoom-out">-</button>
	</div>
</body>

<script>
	var pointOffsetX = 12,
		pointOffsetY = 12,
		poi = [
		{
			x: 1052,
			y: 1318,
			text: "A great and wonderful place, full of joy and laughter."
		},
		{
			x: 1985,
			y: 1005,
			text: "A seaside getaway."
		}
	];

	var map = document.getElementById('map'),
		container = document.getElementById('map-container'),
		viewport = document.getElementById('map-viewport'),
		zoomInBtn = document.getElementById('map-zoom-in'),
		zoomOutBtn = document.getElementById('map-zoom-out'),
		pointInfo = document.getElementById('point-info'),
		pointText = document.getElementById('point-info-text'),
		pointReturn = document.getElementById('point-return'),
		dragging = false,
		mapScale = 1,
		minScale, offsetX, offsetY;

	function handleStartDrag(e) {
		e.preventDefault();

		if(e.target.classList.contains('point')) {
			return;
		}

		dragging = true;
		offsetX = e.offsetX;
		offsetY = e.offsetY;
	}

	function handleDragging(e) {
		if (dragging) {
			var mapPos = getMapPosition();			
			setMapPosition(mapPos.left + e.movementX, mapPos.top + e.movementY);
		}
	}

	function handleStopDrag(e) {
		dragging = false;
	}

	function handleShowPoint(e) {
		for(var p in poi) {
			var point = poi[p];
			
			if(e.target == point.el) {
				pointInfo.style.display = 'flex';
				pointText.innerHTML = point.text;
				break;
			}
		}
	}

	function handleHidePoint() {
		pointInfo.style.display = 'none';
	}

	function setMapScale(scale) {
		var mapPos = getMapPosition();

		mapScale = Math.max(Math.min(scale, 1), minScale);
		container.style.transform = 'scale(' + mapScale + ',' + mapScale + ')';

		//make sure the map stays within the viewport when it's being scaled down.
		var boundedMapPos = setMapPosition(mapPos.left, mapPos.top);
	}

	function getMapPosition() {
		var left = container.style.left || '0px',
			top = container.style.top || '0px';

		left = Number(left.substring(0, left.length - 2));
		top = Number(top.substring(0, top.length - 2));

		return {left: left, top: top};
	}

	function setMapPosition(left, top) {
		var mapRect = container.getBoundingClientRect(),
			mapTopBound = (mapRect.height - map.offsetHeight) / 2,
			mapLeftBound = (mapRect.width - map.offsetWidth) / 2,
			mapRightBound = viewport.offsetWidth - mapRect.width + mapLeftBound,
			mapBottomBound = viewport.offsetHeight - mapRect.height + mapTopBound,
			newLeft = Math.max(Math.min(left, mapLeftBound), mapRightBound),
			newTop = Math.max(Math.min(top, mapTopBound), mapBottomBound);

		container.style.left = newLeft + 'px';
		container.style.top = newTop + 'px';
	}

	function init() {
		initPOI();
		initMapPosition();
	}

	function initMapPosition() {
		//initialize the minimum scale for the map. Round to two decimal places so that the map will always be slightly larger than the container.
		minScale = Math.round((viewport.offsetWidth / map.offsetWidth + 0.00001) * 100) / 100

		//initialize the width of the map to be double the width of the viewport.
		setMapScale(viewport.offsetWidth * 2 / map.offsetWidth);

		container.style.left = ((viewport.offsetWidth - map.offsetWidth) / 2) + 'px';
		container.style.top = ((viewport.offsetHeight - map.offsetHeight) / 2) + 'px';
	}

	function initPOI() {
		for(var p in poi) {
			var point = poi[p],
				pointEl = document.createElement('div');

			point.el = pointEl;

			pointEl.classList.add('point');
			pointEl.style.top = point.y - pointOffsetX + 'px';
			pointEl.style.left = point.x - pointOffsetY + 'px';

			pointEl.addEventListener('click', handleShowPoint);

			container.appendChild(pointEl);
		}
	}

	container.addEventListener('mousedown', handleStartDrag);
	container.addEventListener('mousemove', handleDragging);
	document.addEventListener('mouseup', handleStopDrag);

	zoomInBtn.addEventListener('click', function() {
		setMapScale(mapScale + 0.1);
	});
	zoomOutBtn.addEventListener('click', function() {
		setMapScale(mapScale - 0.1);
	});

	pointReturn.addEventListener('click', handleHidePoint);

	if (map.complete) {
		init();
	} else {
		map.addEventListener('load', init);
	}
</script>

</html>